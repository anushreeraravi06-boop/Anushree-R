<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SafeHer ‚Äî Pro Women Safety</title>
<link rel="manifest" href="manifest.json" id="manifest-link">
<meta name="theme-color" content="#ff4d6d">

<style>
  :root{--bg:#faf8fc;--card:#fff;--muted:#6b7280;--accent:#ff4d6d}
  [data-theme="dark"]{--bg:#0b0c0f;--card:#0f1114;--muted:#9aa3b2;--accent:#ff7a9a;color:#e6eef6}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#071126}
  .wrap{max-width:980px;margin:16px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:1.25rem;margin:0}
  .meta{color:var(--muted);font-size:.9rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(10,10,20,.06)}
  .bigbtn{display:block;width:100%;padding:12px;border-radius:10px;border:none;font-weight:600;font-size:1rem;cursor:pointer}
  .danger{background:linear-gradient(90deg,var(--accent),#ff2e6b);color:white}
  .muted{color:var(--muted)}
  .small{font-size:.85rem;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #eee;background:white}
  .log{font-family:monospace;background:#0f1724;color:#e6eef6;padding:8px;border-radius:8px;overflow:auto;height:120px}
  .ln{margin:8px 0}
  .flex{display:flex;gap:8px;align-items:center}
  .pulse{animation:pulse 1.2s infinite}
  @keyframes pulse{0%{transform:scale(.997)}50%{transform:scale(1.02)}100%{transform:scale(.997)}}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.55);visibility:hidden;opacity:0;transition:opacity .12s}
  .modal.show{visibility:visible;opacity:1}
  .modal .card{max-width:420px}
  .qr{display:block;margin:8px auto;max-width:220px}
  @media (max-width:480px){ header{flex-direction:column;align-items:flex-start} h1{font-size:1.1rem} }
</style>
</head>
<body data-theme="light">
<div class="wrap">
  <header>
    <div>
      <h1>SafeHer ‚Äî Pro Safety</h1>
      <div class="meta">Quick actions, discreet alerts, fake-call, check-ins & PWA-ready</div>
    </div>
    <div class="flex">
      <label class="small">Theme</label>
      <select id="themeToggle" aria-label="Theme toggle">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
  </header>

  <section class="grid" aria-label="Quick actions">
    <div class="card">
      <div class="ln"><strong>Immediate SOS</strong></div>
      <div class="controls">
        <button id="sosBtn" class="bigbtn danger pulse" aria-label="Send critical SOS">üî¥ SOS ‚Äî Critical</button>
        <button id="sosSilentBtn" class="bigbtn" aria-label="Send discreet SOS">üîï Discreet SOS</button>
      </div>
      <div class="small ln">Long-press SOS on mobile or shake device to trigger (enable motion when asked).</div>
      <div class="ln">
        <button id="fakeCallBtn" class="bigbtn">üìû Fake Incoming Call</button>
      </div>
    </div>

    <div class="card">
      <div class="ln"><strong>Share Location</strong></div>
      <div class="controls">
        <button id="shareBtn" class="bigbtn">üìç Share (Web Share / WhatsApp)</button>
        <button id="qrBtn" class="bigbtn">üîó Show QR</button>
      </div>
      <div class="ln"><input id="contactNumber" placeholder="Emergency contact number" aria-label="Emergency contact"></div>
      <div class="ln"><button id="saveContact" class="pill">Save Contact</button> <button id="viewContacts" class="pill">View Contacts</button></div>
    </div>

    <div class="card">
      <div class="ln"><strong>Siren & Alerts</strong></div>
      <div class="controls">
        <button id="startSiren" class="bigbtn">üîä Start Siren</button>
        <button id="stopSiren" class="bigbtn">‚èπ Stop Siren</button>
      </div>
      <div class="small ln">Tip: Siren plays only after a user tap (browser policy)</div>
      <div class="ln"><button id="checkinBtn" class="pill">‚è± Set 10-min check-in</button> <button id="cancelCheckin" class="pill">Cancel</button></div>
    </div>

    <div class="card">
      <div class="ln"><strong>Voice & Motion</strong></div>
      <div class="controls">
        <button id="voiceBtn" class="bigbtn">üéô Start Voice SOS</button>
        <select id="sensitivity" class="pill" aria-label="Shake sensitivity">
          <option value="18">Shake Sensitivity: Normal</option>
          <option value="12">High</option>
          <option value="24">Low</option>
        </select>
      </div>
      <div class="ln small">Voice triggers on words like "help" or "help me". Microphone required.</div>
    </div>
  </section>

  <section class="card ln" aria-live="polite">
    <strong>Live Stream & Debug</strong>
    <div class="ln small">Optional: set a webhook (webhook.site) to receive live location JSON for demos.</div>
    <div class="ln"><input id="webhook" placeholder="Webhook URL (optional)" style="width:100%"></div>
    <div class="ln log" id="log" role="status" aria-live="polite">Log:<br></div>
  </section>

  <footer>
    <div class="small">Limitations: The browser version cannot reliably run in the background or auto-send messages without user action. For full production use (background tracking, auto SMS), build a native app + server. Need help with that? I can provide code.</div>
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="card">
    <div id="modalTitle"><strong>Info</strong></div>
    <pre id="modalBody" style="white-space:pre-wrap"></pre>
    <div style="text-align:right;margin-top:10px"><button id="modalClose" class="pill">OK</button></div>
  </div>
</div>

<audio id="sirenAudio" preload="auto"></audio>

<script>
/* --------- CONFIG - edit only these lines --------- */
const SIREN_URL = '';      // OPTIONAL: paste a direct mp3 URL or leave empty for vibration/beep fallback
const WEBHOOK_DEFAULT = ''; // OPTIONAL: default webhook URL for demo (e.g. webhook.site)
/* ------------------------------------------------- */

document.getElementById('webhook').value = WEBHOOK_DEFAULT;

/* Helper UI */
const logEl = document.getElementById('log');
function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.innerText = `${t} ‚Äî ${msg}\n` + logEl.innerText;
  console.log(msg);
}
function showModal(title, text){
  document.getElementById('modalTitle').innerHTML = '<strong>' + title + '</strong>';
  document.getElementById('modalBody').innerText = text;
  const m = document.getElementById('modal'); m.classList.add('show'); m.setAttribute('aria-hidden','false');
}
document.getElementById('modalClose').onclick = ()=>{ const m=document.getElementById('modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); };

/* Theme toggle */
const theme = document.getElementById('themeToggle');
theme.addEventListener('change', e=> document.body.setAttribute('data-theme', e.target.value));
if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.setAttribute('data-theme','dark'); theme.value='dark'; }

/* Geolocation helper */
function getCurrentPositionPromise(opts={enableHighAccuracy:true,timeout:15000}){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error('Geolocation not supported'));
    navigator.geolocation.getCurrentPosition(p=>resolve(p.coords), err=>reject(err), opts);
  });
}

/* Web Share + WhatsApp fallback */
async function shareLocationMessage(lat,lng){
  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
  const msg = `EMERGENCY! I need help now.\nMy location: ${mapsLink}\nTime: ${new Date().toLocaleString()}`;
  if(navigator.share){
    try{ await navigator.share({title:'EMERGENCY', text: msg, url: mapsLink}); log('Shared via Web Share'); return; } catch(e){ log('Web Share canceled'); }
  }
  const wa = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
  window.open(wa, '_blank');
  try{ await navigator.clipboard.writeText(msg); log('Copied SOS message to clipboard'); } catch(e){ }
}

/* QR helper (uses Google Chart API) */
function generateQRURL(text){
  return 'https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=' + encodeURIComponent(text);
}

/* Siren control */
const sirenAudio = document.getElementById('sirenAudio');
if(SIREN_URL) sirenAudio.src = SIREN_URL;
let sirenPlaying = false;
function startSiren(){
  try{
    if(sirenAudio.src){ sirenAudio.loop = true; sirenAudio.play().catch(e=>log('Audio play blocked: ' + e.message)); }
    else { try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sawtooth'; o.frequency.value=800; o.connect(g); g.connect(ctx.destination); g.gain.value=0; o.start(); g.gain.setTargetAtTime(0.25, ctx.currentTime, 0.01); window._osc={ctx,o,g}; }catch(e){ } }
  }catch(e){ console.warn(e); }
  if(navigator.vibrate) navigator.vibrate([400,200,400,200,1000]);
  sirenPlaying = true; log('Siren started');
}
function stopSiren(){
  try{ if(sirenAudio.src){ sirenAudio.pause(); sirenAudio.currentTime = 0; } if(window._osc){ window._osc.g.gain.setTargetAtTime(0, window._osc.ctx.currentTime, 0.01); } }catch(e){}
  if(navigator.vibrate) navigator.vibrate(0);
  sirenPlaying = false; log('Siren stopped');
}

/* Live streaming to webhook */
let watchId = null;
async function startLiveShareToWebhook(){
  const webhook = document.getElementById('webhook').value.trim();
  try{
    const coords = await getCurrentPositionPromise();
    log(`Live sharing started at ${coords.latitude.toFixed(5)}, ${coords.longitude.toFixed(5)}`);
  }catch(err){ log('Live share failed: ' + (err.message||err.code)); return; }
  watchId = navigator.geolocation.watchPosition(async p=>{
    const payload = { event:'sos_update', ts:new Date().toISOString(), lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy };
    log(`Stream: ${payload.lat.toFixed(5)}, ${payload.lng.toFixed(5)}`);
    if(webhook){
      try{ await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }catch(e){ console.warn('Webhook error', e); }
    }
  }, e=>log('watchPosition error: ' + (e.message||e.code)), { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
}
function stopLiveShare(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; log('Stopped live stream'); } }

/* SOS flows */
async function sendCriticalSOS(){
  try{
    const coords = await getCurrentPositionPromise();
    startSiren();
    startLiveShareToWebhook();
    await shareLocationMessage(coords.latitude, coords.longitude);
    log('Critical SOS initiated');
  }catch(err){ log('SOS failed: ' + (err.message||err.code)); showModal('SOS Failed', 'Allow Location permission and try again.'); }
}
async function sendDiscreetSOS(){
  try{
    const coords = await getCurrentPositionPromise();
    if(navigator.vibrate) navigator.vibrate([200,100,200]);
    await shareLocationMessage(coords.latitude, coords.longitude);
    startLiveShareToWebhook();
    log('Discreet SOS sent');
    showModal('Discreet SOS', 'Message prepared. Paste/send it manually in WhatsApp or your messaging app.');
  }catch(err){ log('Discreet SOS error: ' + (err.message||err.code)); }
}

/* Fake incoming call */
function fakeIncomingCall(){
  const duration = 12000;
  const holder = document.createElement('div'); holder.className='modal show';
  holder.innerHTML = `<div class="card fake-call" style="text-align:center"><strong>Incoming call</strong><div style="margin-top:8px">Call from: +91 98765 43210</div><div style="margin-top:12px"><button id="fEnd" class="pill">End</button></div></div>`;
  document.body.appendChild(holder);
  document.getElementById('fEnd').onclick = ()=> { holder.remove(); };
  setTimeout(()=> holder.remove(), duration);
  log('Fake call shown');
}

/* Voice recognition */
let recog = null;
function startVoiceListen(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){ log('SpeechRecognition unsupported'); showModal('Not supported', 'Voice SOS not supported on this browser'); return; }
  recog = new SpeechRecognition();
  recog.continuous = true; recog.lang = 'en-IN'; recog.interimResults = false;
  recog.onresult = (ev) => {
    const text = Array.from(ev.results).map(r=>r[0].transcript).join(' ').toLowerCase();
    log('Voice heard: ' + text);
    if(text.includes('help') || text.includes('help me')){ log('Voice SOS triggered'); startSiren(); startLiveShareToWebhook(); }
  };
  recog.onerror = (e)=> log('Voice error: ' + e.error);
  recog.start(); log('Voice listening started (allow microphone)');
}

/* Shake detection */
let lastX=0,lastY=0,lastZ=0,lastTime=0;
let shakeThreshold = 18;
function setSensitivity(val){ shakeThreshold = Number(val); log('Shake sensitivity: ' + shakeThreshold); }
function deviceMotionHandler(e){
  const acc = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
  const curTime = Date.now();
  if((curTime - lastTime) > 150){
    const diffTime = curTime - lastTime;
    lastTime = curTime;
    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
    if(delta > shakeThreshold){ log('Shake detected (delta: ' + delta.toFixed(1) + ')'); sendDiscreetSOS(); }
    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
  }
}

/* Check-in timer */
let checkinTimer = null;
function setCheckIn(minutes=10){
  cancelCheckIn();
  const ms = minutes * 60 * 1000;
  checkinTimer = setTimeout(async ()=>{
    log('Check-in missed ‚Äî auto-escalation');
    try{ const coords = await getCurrentPositionPromise(); await shareLocationMessage(coords.latitude, coords.longitude); startLiveShareToWebhook(); showModal('Missed Check-in', 'Sent your location automatically.'); }catch(e){ log('Auto-escalation failed: ' + (e.message||e.code)); }
  }, ms);
  log(`Check-in set for ${minutes} minutes`);
}
function cancelCheckIn(){ if(checkinTimer){ clearTimeout(checkinTimer); checkinTimer=null; log('Check-in canceled'); } }

/* Contacts */
function saveContact(){
  const num = document.getElementById('contactNumber').value.trim();
  if(!num){ showModal('No number', 'Enter a contact number'); return; }
  const list = JSON.parse(localStorage.getItem('safeher_contacts')||'[]');
  list.unshift({number:num,ts:new Date().toISOString()});
  localStorage.setItem('safeher_contacts', JSON.stringify(list.slice(0,6)));
  log('Contact saved: ' + num);
  showModal('Contact saved', num);
}
function viewContacts(){
  const list = JSON.parse(localStorage.getItem('safeher_contacts')||'[]');
  if(!list.length){ showModal('No contacts', 'No emergency contacts saved yet.'); return; }
  const s = list.map(c=>`${c.number} (saved ${new Date(c.ts).toLocaleString()})`).join('\n');
  showModal('Saved contacts', s);
}

/* QR display */
async function showQRofLocation(){
  try{
    const coords = await getCurrentPositionPromise();
    const mapsLink = `https://www.google.com/maps/search/?api=1&query=${coords.latitude},${coords.longitude}`;
    const url = generateQRURL(mapsLink);
    showModal('QR - share this link', mapsLink + '\n\nLong-press the QR to save it.');
    const img = document.createElement('img'); img.src = url; img.className='qr';
    const mb = document.getElementById('modalBody'); mb.innerText = mapsLink + '\n\n'; mb.appendChild(img);
  }catch(e){ log('QR failed: ' + (e.message||e.code)); showModal('Error', 'Could not get location'); }
}

/* Small utility: create manifest + service worker on the fly for PWA install */
async function createManifestAndSW(){
  const manifest = { name:'SafeHer', short_name:'SafeHer', start_url:'.', display:'standalone', background_color:'#ffffff', theme_color:'#ff4d6d', icons:[{ src:'data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" height="192" width="192"><rect width="100%" height="100%" fill="#ff4d6d"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="80" fill="#fff">SH</text></svg>`), sizes:'192x192', type:'image/svg+xml' }] };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  document.getElementById('manifest-link').setAttribute('href', url);

  if('serviceWorker' in navigator){
    try{
      const swCode = `const CACHE_NAME='safeher-v1';self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(['/','/index.html'])));});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;
      const swBlob = new Blob([swCode], {type:'application/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      await navigator.serviceWorker.register(swUrl);
      log('Service worker registered (PWA ready)');
    }catch(e){ console.warn('SW error', e); }
  }
}
createManifestAndSW();

/* Wiring UI */
document.getElementById('sosBtn').onclick = sendCriticalSOS;
document.getElementById('sosSilentBtn').onclick = sendDiscreetSOS;
document.getElementById('startSiren').onclick = startSiren;
document.getElementById('stopSiren').onclick = stopSiren;
document.getElementById('shareBtn').onclick = async ()=>{ try{ const c = await getCurrentPositionPromise(); await shareLocationMessage(c.latitude,c.longitude); showModal('Shared','Share dialog opened (or WhatsApp).'); }catch(e){ showModal('Error','Could not get location'); log('Share error: ' + (e.message||e.code)); } };
document.getElementById('qrBtn').onclick = showQRofLocation;
document.getElementById('fakeCallBtn').onclick = fakeIncomingCall;
document.getElementById('saveContact').onclick = saveContact;
document.getElementById('viewContacts').onclick = viewContacts;
document.getElementById('voiceBtn').onclick = startVoiceListen;
document.getElementById('checkinBtn').onclick = ()=> setCheckIn(10);
document.getElementById('cancelCheckin').onclick = cancelCheckIn;
document.getElementById('sensitivity').onchange = (e)=> setSensitivity(e.target.value);

/* long-press SOS on touch */
let pressTimer;
const sosEl = document.getElementById('sosBtn');
sosEl.addEventListener('touchstart', e=> { pressTimer = setTimeout(()=> { sendCriticalSOS(); }, 900); });
sosEl.addEventListener('touchend', e=> { if(pressTimer) clearTimeout(pressTimer); });

/* request motion permission on iOS when user interacts */
async function enableMotion(){
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    try{ const p = await DeviceMotionEvent.requestPermission(); if(p==='granted'){ window.addEventListener('devicemotion', deviceMotionHandler, false); log('Motion permission granted'); } }catch(e){ log('Motion permission denied'); }
  } else { window.addEventListener('devicemotion', deviceMotionHandler, false); }
}
document.body.addEventListener('click', enableMotion, { once:true });

/* permission logging */
async function checkPermissions(){ if(!navigator.permissions) return; try{ const p = await navigator.permissions.query({ name:'geolocation' }); log('Geolocation permission: ' + p.state); p.onchange = ()=> log('Permission changed: ' + p.state); }catch(e){} }
checkPermissions();
</script>
</body>
</html>
